/*
TextBox v0.2.3
Plugin que sirve para precargar la librería textboxio de ephox de acuerdo a estándar de ecosistema VALORA
Autor: Real Ace One
*/
if("undefined"===!window.jQuery)throw new Error("Cargue primero la librería JQuery");!function(){"use strict";var e,t,r,o,a="Textboxio",n="No se puede cargar la librería "+a+" %s",i="Ha ocurrido un problema con la subida del archivo. Por favor intente nuevamente. %s",l="No se puede cargar la instancia del editor.",d='Falta el parámetro "%s"',s='"%s" debe ser un string.',u='"%s" debe ser un objeto.',c='"%s" debe ser boolean.',g='"%s" debe ser una función.',m='"%s" debe ser númerico.',p="No se encontró ningún elemento para reemplazar.",f='Se crea instancia de editor en "%s"',h='Se guarda contenido en elemento "%s"',b="No se encuentra la librería "+a+". Se intentará cargar dinámicamente.",w="Se cargó exitosamente la librería "+a+".",_='Se cargó la barra de herramientas en modo "%s"',x="Se carga GUI del editor.",E='Se cargó el archivo en el servidor con ruta de acceso "%s"',v="El elemento en que se intenta guardar el contenido del editor no está permitido.",y="Sólo se permiten elementos de tipo DIV o TEXTAREA.",S="/assets/vendor/plugins/textboxio/textboxio.js",T="/assets/vendor/plugins/textboxio/",A=!1,I=window,j=function(e){console.log(e)},z=function(){var e={debug_mode:!1,toolbar:"normal",img_upload_url:"/default/subir-complemento/",img_upload_response:{success:function(e,t,r){},fail:function(e,t,r){}},resize_uploaded_img:{enabled:!1,maxWidth:600,maxHeight:600},config:{codeview:{enabled:!1,showButton:!1},autosubmit:!0,basePath:T,images:{allowLocal:!0,upload:{handler:function(e,t,o){P(e.blob(),e.filename(),function(e){e.done(function(e,o,a){if(r.img_upload_response.success(e,o,a),!e.result)throw r.debug_mode&&j(a),new Error(i.replace("%s",""));r.debug_mode&&j(E.replace("%s",e.ruta)),t(e.ruta)}).fail(function(e,t,o){throw r.img_upload_response.fail(e,t,o),r.debug_mode&&j(e),new Error(i.replace("%s","("+o+")"))})})}}}}};return I.textboxio&&delete e.config.basePath,e},N=function(){switch(r.toolbar){case"tiny":r.config.ui={toolbar:{items:[{label:"Undo and Redo group",items:["undo","redo"]},{label:"Emphasis group",items:["bold","italic","underline"]},{label:"Format group",items:["font-menu","removeformat"]}]}};break;case"normal":r.config.ui={toolbar:{items:[{label:"Undo and Redo group",items:["undo","redo"]},{label:"Insert group",items:[{id:"insert",label:"Insertar",items:["fileupload","table","specialchar","hr"]}]},{label:"Styles group",items:["styles"]},{label:"Emphasis group",items:["bold","italic","underline"]},{label:"Align group",items:["alignment"]},{label:"Listindent group",items:["ul","ol","indent","outdent","blockquote"]},{label:"Format group",items:["font-menu","removeformat"]},{label:"Tools group",items:["find","fullscreen","usersettings"]}]}}}},R=function(e){$.each(e,function(e,t){if(!/TEXTAREA|DIV/i.test(t.nodeName))throw new Error(y);try{var o=textboxio.replace(t,r.config)}catch(a){I.textboxio&&!r.config.basePath&&(r.config.basePath=T);var o=textboxio.replace(t,r.config)}r.debug_mode&&(j(f.replace("%s",t.nodeName)),j(t)),o.events.loaded.addListener(function(){/TEXTAREA/i.test(t.nodeName)&&$.data(o.element(),"element",t),r.debug_mode&&j(x)}),o.events.focus.addListener(function(){/TEXTAREA/i.test(t.nodeName)&&$.data(o.element(),"element",t)})})},P=function(e,t,o){var a,n,i,l=new FormData,d=new FileReader;d.onload=function(e){var d=new Image;d.onload=function(e){var s=document.createElement("canvas");D(d,s,r.resize_uploaded_img.maxWidth,r.resize_uploaded_img.maxHeight),i=s.toDataURL(),a=L(i),l.append("file",a),l.append("name",t),n=$.ajax({url:r.img_upload_url,type:"POST",dataType:"json",async:!0,cache:!1,data:l,contentType:!1,processData:!1}),o(n)},d.src=e.target.result},d.readAsDataURL(e)},D=function(e,t,o,a){var n=e.width,i=e.height,l=r.resize_uploaded_img.enabled&&n>o?!0:!1,d=1,s=1,u=1,s=o/n,u=a/i;d=u>s?s:u;var c=t.getContext("2d"),g=document.createElement("canvas"),m=g.getContext("2d"),p=document.createElement("canvas"),f=p.getContext("2d");g.width=n,g.height=i,m.drawImage(e,0,0),p.width=n,p.height=i,f.drawImage(g,0,0,g.width,g.height,0,0,p.width,p.height);for(var h=2,b=d*h,w=1;h>=w;w++)l?(g.width=n*b/w,g.height=i*b/w):(g.width=n,g.height=i),m.drawImage(p,0,0,p.width,p.height,0,0,g.width,g.height),l?(p.width=n*b/w,p.height=i*b/w):(p.width=n,p.height=i),f.drawImage(g,0,0,g.width,g.height,0,0,p.width,p.height);l?(t.width=n*b/h,t.height=i*b/h):(t.width=n,t.height=i),c.drawImage(p,0,0,p.width,p.height,0,0,t.width,t.height)},L=function(e){var t=";base64,";if(-1==e.indexOf(t)){var r=e.split(","),o=r[0].split(":")[1],a=r[1];return new Blob([a],{type:o})}for(var r=e.split(t),o=r[0].split(":")[1],a=window.atob(r[1]),n=a.length,i=new Uint8Array(n),l=0;n>l;++l)i[l]=a.charCodeAt(l);return new Blob([i],{type:o})},H=function(){A||(e=$.ajax({dataType:"script",cache:!1,async:!0,url:S,beforeSend:function(){A=!0}}).fail(function(e,t,o){throw r.debug_mode&&j(e),new Error(n.replace("%s","("+o+")"))}))},O=function(){if("boolean"!=typeof r.debug_mode)throw new Error(c.replace("%s","debug_mode"));if("string"!=typeof r.toolbar)throw new Error(s.replace("%s","toolbar"));if("string"!=typeof r.img_upload_url)throw new Error(s.replace("%s","img_upload_url"));if("function"!=typeof r.img_upload_response.success)throw new Error(g.replace("%s","img_upload_response.success"));if("function"!=typeof r.img_upload_response.fail)throw new Error(g.replace("%s","img_upload_response.fail"));if("boolean"!=typeof r.resize_uploaded_img.enabled)throw new Error(c.replace("%s","resize_uploaded_img.enabled"));if("number"!=typeof r.resize_uploaded_img.maxWidth)throw new Error(m.replace("%s","resize_uploaded_img.maxWidth"));if("number"!=typeof r.resize_uploaded_img.maxHeight)throw new Error(m.replace("%s","resize_uploaded_img.maxHeight"))},o={get:function(e){if(0==arguments.length)throw new Error(d.replace("%s","selector"));if("string"!=typeof e)throw new Error(s.replace("%s","Selector"));return textboxio.get(e)},triggerSave:function(e){if(0==arguments.length)throw new Error(d.replace("%s","selector"));if("string"!=typeof e)throw new Error(s.replace("%s","Selector"));var t=o.get(e);if(!(t.length>0))throw new Error(l);$.each(t,function(e,t){if(t.content.isDirty()){var o=$.data(t.element(),"element");if("object"==typeof o){var a=t.content.get();/TEXTAREA/i.test(o.nodeName)?(o.innerHTML=a,r.debug_mode&&(j(h.replace("%s",o.nodeName)),j(o))):r.debug_mode&&(j(v),j(o))}else r.debug_mode&&(j(v),j(o));t.content.setDirty(!1)}})},replace:function(o,a){if(0==arguments.length)throw new Error(d.replace("%s","selector"));if("string"!=typeof o)throw new Error(s.replace("%s","Selector"));if("undefined"!=typeof a&&"object"!=typeof a)throw new Error(u.replace("%s","Argument 2"));if(o=$(o),t=z(),r=$.extend(!0,{},t,a),N(),O(),o.length>0)if(I.textboxio)R(o);else{r.debug_mode&&j(b),H();var n=I.setInterval(function(){4==e.readyState&&200==e.status&&(r.debug_mode&&(j(w),j(_.replace("%s",r.toolbar))),clearInterval(n),R(o))},1e3)}else r.debug_mode&&j(p)}};Object.preventExtensions(o),Object.defineProperty(o,"get",{writable:!1,configurable:!1,enumerable:!0}),Object.defineProperty(o,"triggerSave",{writable:!1,configurable:!1,enumerable:!0}),Object.defineProperty(o,"replace",{writable:!1,configurable:!1,enumerable:!0}),I.textboxValora=o}(this);