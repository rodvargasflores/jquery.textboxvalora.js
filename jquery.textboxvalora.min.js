/*
TextBox v0.1.1
Plugin que sirve para precargar la librería textboxio de ephox de acuerdo a estándar de ecosistema VALORA
Autor: Real Ace One
*/
if("undefined"===!window.jQuery)throw new Error("Cargue primero la librería JQuery");!function(e){var o,a,n,i,l="Textboxio",s="No se puede cargar la librería "+l+" %s",u="Ha ocurrido un problema con la subida del archivo. Por favor intente nuevamente. %s",g="No se puede cargar la instancia del editor.",h='Falta el parámetro "%s"',m='"%s" debe ser un string.',p='"%s" debe ser un objeto.',f="No se encontró ningún elemento para reemplazar.",b='Se crea instancia de editor en "%s"',w='Se guarda contenido en elemento "%s"',x="No se encuentra la librería "+l+". Se intentará cargar dinámicamente.",_="Se cargó exitosamente la librería "+l+".",v='Se cargó la barra de tareas en modo "%s"',E='Se cargó el archivo en el servidor con ruta de acceso "%s"',y="Sólo se permiten elementos de tipo DIV o TEXTAREA.",S="/assets/vendor/plugins/textboxio/textboxio.js",T="/assets/vendor/plugins/textboxio/",I=!1,A=window,j=function(e){console.log(e)},N=function(){return d={debug_mode:!1,toolbar:"normal",img_upload_url:"/default/subir-complemento/",img_upload_response:{success:function(e,t,r){},fail:function(e,t,r){}},resize_uploaded_img:{enabled:!1,maxWidth:600,maxHeight:600},config:{codeview:{enabled:!1,showButton:!1},autosubmit:!0,basePath:T,images:{allowLocal:!0,upload:{handler:function(e,t,r){D(e.blob(),e.filename(),function(e){e.done(function(e,r,o){if(n.img_upload_response.success(e,r,o),!e.result)throw n.debug_mode&&j(o),new Error(u.replace("%s",""));n.debug_mode&&j(E.replace("%s",e.ruta)),t(e.ruta)}).fail(function(e,t,r){throw n.img_upload_response.fail(e,t,r),n.debug_mode&&j(e),new Error(u.replace("%s","("+r+")"))})})}}}}},A.textboxio&&delete d.config.basePath,d},R=function(){switch(n.toolbar){case"tiny":n.config.ui={toolbar:{items:[{label:"Undo and Redo group",items:["undo","redo"]},{label:"Emphasis group",items:["bold","italic","underline"]},{label:"Format group",items:["font-menu","removeformat"]}]}};break;case"normal":n.config.ui={toolbar:{items:[{label:"Undo and Redo group",items:["undo","redo"]},{label:"Insert group",items:[{id:"insert",label:"Insertar",items:["fileupload","table","specialchar","hr"]}]},{label:"Styles group",items:["styles"]},{label:"Emphasis group",items:["bold","italic","underline"]},{label:"Align group",items:["alignment"]},{label:"Listindent group",items:["ul","ol","indent","outdent","blockquote"]},{label:"Format group",items:["font-menu","removeformat"]},{label:"Tools group",items:["find","fullscreen","usersettings"]}]}}}},U=function(t){e.each(t,function(e,t){if(!/TEXTAREA|DIV/i.test(t.nodeName))throw new Error(y);try{textboxio.replace(t,n.config)}catch(r){A.textboxio&&!n.config.basePath&&(n.config.basePath=T),textboxio.replace(t,n.config)}n.debug_mode&&(j(b.replace("%s",t.nodeName)),j(t))})},D=function(t,r,o){var a,i,l=new FormData,d=new FileReader;d.onload=function(t){var d=new Image;d.onload=function(t){var s=document.createElement("canvas");P(d,s,n.resize_uploaded_img.maxWidth,n.resize_uploaded_img.maxHeight),dataUrl=s.toDataURL(),a=z(dataUrl),l.append("file",a),l.append("name",r),i=e.ajax({url:n.img_upload_url,type:"POST",dataType:"json",async:!0,cache:!1,data:l,contentType:!1,processData:!1}),o(i)},d.src=t.target.result},d.readAsDataURL(t)},P=function(e,t,r,o){var a=e.width,i=e.height,l=n.resize_uploaded_img.enabled&&a>r?!0:!1,d=1,s=1,c=1;s=r/a,c=o/i,d=c>s?s:c;var u=t.getContext("2d"),g=document.createElement("canvas"),h=g.getContext("2d"),m=document.createElement("canvas"),p=m.getContext("2d");g.width=a,g.height=i,h.drawImage(e,0,0),m.width=a,m.height=i,p.drawImage(g,0,0,g.width,g.height,0,0,m.width,m.height);for(var f=2,b=d*f,w=1;f>=w;w++)l?(g.width=a*b/w,g.height=i*b/w):(g.width=a,g.height=i),h.drawImage(m,0,0,m.width,m.height,0,0,g.width,g.height),l?(m.width=a*b/w,m.height=i*b/w):(m.width=a,m.height=i),p.drawImage(g,0,0,g.width,g.height,0,0,m.width,m.height);l?(t.width=a*b/f,t.height=i*b/f):(t.width=a,t.height=i),u.drawImage(m,0,0,m.width,m.height,0,0,t.width,t.height)},z=function(e){var t=";base64,";if(-1==e.indexOf(t)){var r=e.split(","),o=r[0].split(":")[1],a=r[1];return new Blob([a],{type:o})}for(var r=e.split(t),o=r[0].split(":")[1],a=window.atob(r[1]),n=a.length,i=new Uint8Array(n),l=0;n>l;++l)i[l]=a.charCodeAt(l);return new Blob([i],{type:o})},C=function(){I||(o=e.ajax({dataType:"script",cache:!1,async:!0,url:S,beforeSend:function(){I=!0}}).fail(function(e,t,r){throw n.debug_mode&&j(e),new Error(s.replace("%s","("+r+")"))}))},i={get:function(e){if(0==arguments.length)throw new Error(h.replace("%s","selector"));if("string"!=typeof e)throw new Error(m.replace("%s","Selector"));return textboxio.get(e)},triggerSave:function(o){if(0==arguments.length)throw new Error(h.replace("%s","selector"));if("string"!=typeof o)throw new Error(m.replace("%s","Selector"));if(editors=i.get(o),!(editors.length>0))throw new Error(g);e.each(editors,function(o,a){r=e(document).find(a.element()).parent(),r.length>0&&(t=r.next(),c=a.content.get(),/TEXTAREA/i.test(t[0].nodeName)?(t[0].innerHTML=c,n.debug_mode&&(j(w.replace("%s",t[0].nodeName)),j(t[0]))):n.debug_mode)})},replace:function(t,r){if(0==arguments.length)throw new Error(h.replace("%s","selector"));if("string"!=typeof t)throw new Error(m.replace("%s","Selector"));if("undefined"!=typeof r&&"object"!=typeof r)throw new Error(p.replace("%s","Argument 2"));if(t=e(t),a=N(),n=e.extend(!0,{},a,r),R(),t.length>0)if(A.textboxio)U(t);else{n.debug_mode&&j(x),C();var i=A.setInterval(function(){4==o.readyState&&200==o.status&&(n.debug_mode&&(j(_),j(v.replace("%s",n.toolbar))),clearInterval(i),U(t))},1e3)}else n.debug_mode&&j(f)}};A.textboxValora=i}(jQuery);