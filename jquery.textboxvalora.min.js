/*
TextBox v0.6.0.0
Plugin que sirve para precargar la librería textboxio de ephox de acuerdo a estándar de ecosistema VALORA
Autor: Real Ace One
*/
if("undefined"===!window.jQuery)throw new Error("Cargue primero la librería JQuery");!function(){"use strict";var e,t,o,r="Textboxio",i="No se puede cargar la librería "+r+" %s",n="Ha ocurrido un problema con la subida del archivo. Por favor intente nuevamente. %s",a='Falta el parámetro "%s"',l='"%s" debe ser un string.',s='"%s" debe ser un objeto.',d='"%s" debe ser boolean.',c='"%s" debe ser una función.',u='"%s" debe ser númerico.',g="El elemento en que se intenta guardar el contenido del editor no está permitido.",h="/assets/vendor/plugins/textboxio/",m=!1,p=window,f=function(e){console.log(e)},b=function(e){$.each(e,function(e,t){if(!/TEXTAREA|DIV/i.test(t.nodeName))throw new Error("Sólo se permiten elementos de tipo DIV o TEXTAREA.");try{var r=textboxio.replace(t,o.config)}catch(e){p.textboxio&&!o.config.basePath&&(o.config.basePath=h);r=textboxio.replace(t,o.config)}o.debug_mode&&(f('Se crea instancia de editor en "%s"'.replace("%s",t.nodeName)),f(t)),r.events.loaded.addListener(function(){var e=r.content.documentElement().body,i=r.element(),n=$(document).find(i).parent();if(/TEXTAREA/i.test(t.nodeName)&&$.data(r.element(),"element",t),o.debug_mode&&f("Se carga GUI del editor."),o.autoresize){var a=e.offsetHeight+81;a>o.init_height?n.height(a):n.height(o.init_height)}else n.height(o.init_height)}),r.events.focus.addListener(function(){/TEXTAREA/i.test(t.nodeName)&&$.data(r.element(),"element",t)}),r.events.dirty.addListener(function(){if(o.autoresize&&/TEXTAREA/i.test(t.nodeName)){var e=r.element(),i=$(document).find(e).parent();setInterval(function(){try{var e=r.content.documentElement(),t=e.querySelector("html"),n=e.querySelector("body"),a=n.offsetHeight+71;t.style.minHeight="inherit",t.style.height="inherit",n.style.minHeight=o.init_height-41+"px",a>o.init_height?i.height(a):i.height(o.init_height)}catch(e){}},500)}})})},w=function(e,t,r){var i,n,a,l=new FormData,s=new FileReader;s.onload=function(e){var s=new Image;s.onload=function(e){var d=document.createElement("canvas");_(s,d,o.resize_uploaded_img.maxWidth,o.resize_uploaded_img.maxHeight),a=d.toDataURL(),i=x(a),l.append("file",i),l.append("name",t),n=$.ajax({url:o.img_upload_url,type:"POST",dataType:"json",async:!0,cache:!1,data:l,contentType:!1,processData:!1}),r(n)},s.src=e.target.result},s.readAsDataURL(e)},_=function(e,t,r,i){var n=e.width,a=e.height,l=!!(o.resize_uploaded_img.enabled&&n>r),s=1,d=1,c=1;s=(d=r/n)<(c=i/a)?d:c;var u=t.getContext("2d"),g=document.createElement("canvas"),h=g.getContext("2d"),m=document.createElement("canvas"),p=m.getContext("2d");g.width=n,g.height=a,h.drawImage(e,0,0),m.width=n,m.height=a,p.drawImage(g,0,0,g.width,g.height,0,0,m.width,m.height);for(var f=2*s,b=1;b<=2;b++)l?(g.width=n*f/b,g.height=a*f/b):(g.width=n,g.height=a),h.drawImage(m,0,0,m.width,m.height,0,0,g.width,g.height),l?(m.width=n*f/b,m.height=a*f/b):(m.width=n,m.height=a),p.drawImage(g,0,0,g.width,g.height,0,0,m.width,m.height);l?(t.width=n*f/2,t.height=a*f/2):(t.width=n,t.height=a),u.drawImage(m,0,0,m.width,m.height,0,0,t.width,t.height)},x=function(e){var t=";base64,";if(-1==e.indexOf(t)){var o=(i=e.split(","))[0].split(":")[1],r=i[1];return new Blob([r],{type:o})}o=(i=e.split(t))[0].split(":")[1];for(var i,n=(r=window.atob(i[1])).length,a=new Uint8Array(n),l=0;l<n;++l)a[l]=r.charCodeAt(l);return new Blob([a],{type:o})},y={get:function(e){if(window.textboxio){if(0==arguments.length)throw new Error(a.replace("%s","selector"));if("string"!=typeof e)throw new Error(l.replace("%s","Selector"));return textboxio.get(e)}return!1},triggerSave:function(e){if(0==arguments.length)throw new Error(a.replace("%s","selector"));if("string"!=typeof e)throw new Error(l.replace("%s","Selector"));var t=y.get(e);t.length>0&&$.each(t,function(e,t){if(t.content.isDirty()){var r=$.data(t.element(),"element");if("object"==typeof r){var i=t.content.get();/TEXTAREA/i.test(r.nodeName)?(r.innerHTML=i.replace(/^(<p[^>]*>(&nbsp;|&#160;|\s|\u00a0|)*<br \/>*[\r\n]*<\/p>*)$/,""),o.debug_mode&&(f('Se guarda contenido en elemento "%s"'.replace("%s",r.nodeName)),f(r))):o.debug_mode&&(f(g),f(r))}else o.debug_mode&&(f(g),f(r));t.content.setDirty(!1)}})},replace:function(r,g){if(0==arguments.length)throw new Error(a.replace("%s","selector"));if(void 0===r||"number"==typeof r)throw new Error(l.replace("%s","Selector")+" o "+s.replace("%s","Selector"));if(void 0!==g&&"object"!=typeof g)throw new Error(s.replace("%s","Argument 2"));var _,x;if(r=$(r),_={debug_mode:!1,toolbar:"normal",autoresize:!1,init_height:200,img_upload_url:"/default/index/subir-complemento/",img_upload_response:{success:function(e,t,o){},fail:function(e,t,o){}},resize_uploaded_img:{enabled:!1,maxWidth:600,maxHeight:600},show_loading_text:{enabled:!0,text:"Cargando información...",icon:"fa-spinner",cclass:"form-control-static",style:"margin:0px!important;"},config:{codeview:{enabled:!1,showButton:!1},autosubmit:!0,basePath:h,images:{allowLocal:!0,upload:{handler:function(e,t,r){w(e.blob(),e.filename(),function(e){e.done(function(e,r,i){if(o.img_upload_response.success(e,r,i),!e.result)throw o.debug_mode&&f(i),new Error(n.replace("%s",""));o.debug_mode&&f('Se cargó el archivo en el servidor con ruta de acceso "%s"'.replace("%s",e.ruta)),t(e.ruta)}).fail(function(e,t,r){throw o.img_upload_response.fail(e,t,r),o.debug_mode&&f(e),new Error(n.replace("%s","("+r+")"))})})}}}}},p.textboxio&&delete _.config.basePath,t=_,o=$.extend(!0,{},t,g),function(){switch(o.toolbar){case"tiny":o.config.ui={toolbar:{items:[{label:"Undo and Redo group",items:["undo","redo"]},{label:"Insert group",items:[{id:"insert",label:"Insertar",items:["link"]}]},{label:"Emphasis group",items:["bold","italic","underline"]},{label:"Format group",items:["font-menu","removeformat"]}]}};break;case"normal":o.config.ui={toolbar:{items:[{label:"Undo and Redo group",items:["undo","redo"]},{label:"Insert group",items:[{id:"insert",label:"Insertar",items:["link","fileupload","table","specialchar","hr"]}]},{label:"Styles group",items:["styles"]},{label:"Emphasis group",items:["bold","italic","underline"]},{label:"Align group",items:["alignment"]},{label:"Listindent group",items:["ul","ol","indent","outdent","blockquote"]},{label:"Format group",items:["font-menu","removeformat"]},{label:"Tools group",items:["find","fullscreen","usersettings"]}]}}}}(),function(){if("boolean"!=typeof o.debug_mode)throw new Error(d.replace("%s","debug_mode"));if("string"!=typeof o.toolbar)throw new Error(l.replace("%s","toolbar"));if("boolean"!=typeof o.autoresize)throw new Error(d.replace("%s","autoresize"));if("number"!=typeof o.init_height)throw new Error(u.replace("%s","init_height"));if("string"!=typeof o.img_upload_url)throw new Error(l.replace("%s","img_upload_url"));if("function"!=typeof o.img_upload_response.success)throw new Error(c.replace("%s","img_upload_response.success"));if("function"!=typeof o.img_upload_response.fail)throw new Error(c.replace("%s","img_upload_response.fail"));if("boolean"!=typeof o.resize_uploaded_img.enabled)throw new Error(d.replace("%s","resize_uploaded_img.enabled"));if("number"!=typeof o.resize_uploaded_img.maxWidth)throw new Error(u.replace("%s","resize_uploaded_img.maxWidth"));if("number"!=typeof o.resize_uploaded_img.maxHeight)throw new Error(u.replace("%s","resize_uploaded_img.maxHeight"))}(),r.length>0)if(p.textboxio)b(r);else{o.debug_mode&&f("No se encuentra la librería Textboxio. Se intentará cargar dinámicamente."),m||(e=$.ajax({dataType:"script",cache:!1,async:!0,url:"/assets/vendor/plugins/textboxio/textboxio.js",beforeSend:function(){m=!0}}).fail(function(e,t,r){throw o.debug_mode&&f(e),new Error(i.replace("%s","("+r+")"))})),o.show_loading_text.enabled&&((x=r).hide(),x.each(function(e,t){$(t).parent().append('<label class="loadingTextboxValora '+o.show_loading_text.cclass+'" style="'+o.show_loading_text.style+'"><i class="fa fa-spin '+o.show_loading_text.icon+'"></i> '+o.show_loading_text.text+"</label>")}));var y=p.setInterval(function(){var t;4==e.readyState&&200==e.status&&(o.debug_mode&&(f("Se cargó exitosamente la librería Textboxio."),f('Se cargó la barra de herramientas en modo "%s"'.replace("%s",o.toolbar))),clearInterval(y),o.show_loading_text.enabled&&(t=r,$(".loadingTextboxValora").remove(),t.show()),b(r))},1e3)}else o.debug_mode&&f("No se encontró ningún elemento para reemplazar.")}};Object.preventExtensions(y),Object.defineProperty(y,"get",{writable:!1,configurable:!1,enumerable:!0}),Object.defineProperty(y,"triggerSave",{writable:!1,configurable:!1,enumerable:!0}),Object.defineProperty(y,"replace",{writable:!1,configurable:!1,enumerable:!0}),p.textboxValora=y}();
