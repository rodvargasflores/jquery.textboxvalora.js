/*
TextBox v0.5.0
Plugin que sirve para precargar la librería textboxio de ephox de acuerdo a estándar de ecosistema VALORA
Autor: Real Ace One
*/
if("undefined"===!window.jQuery)throw new Error("Cargue primero la librería JQuery");!function(){"use strict";var e,t,o,r,n="Textboxio",i="No se puede cargar la librería "+n+" %s",a="Ha ocurrido un problema con la subida del archivo. Por favor intente nuevamente. %s",l='Falta el parámetro "%s"',s='"%s" debe ser un string.',d='"%s" debe ser un objeto.',c='"%s" debe ser boolean.',u='"%s" debe ser una función.',g='"%s" debe ser númerico.',h="No se encontró ningún elemento para reemplazar.",m='Se crea instancia de editor en "%s"',p='Se guarda contenido en elemento "%s"',f="No se encuentra la librería "+n+". Se intentará cargar dinámicamente.",b="Se cargó exitosamente la librería "+n+".",w='Se cargó la barra de herramientas en modo "%s"',_="Se carga GUI del editor.",x='Se cargó el archivo en el servidor con ruta de acceso "%s"',y="El elemento en que se intenta guardar el contenido del editor no está permitido.",v="Sólo se permiten elementos de tipo DIV o TEXTAREA.",E="Cargando editor, por favor espere...",T="/assets/vendor/plugins/textboxio/textboxio.js",S="/assets/vendor/plugins/textboxio/",A=!1,z=window,I=function(e){console.log(e)},j=function(){var e={debug_mode:!1,toolbar:"normal",autoresize:!1,init_height:200,img_upload_url:"/default/subir-complemento/",img_upload_response:{success:function(e,t,o){},fail:function(e,t,o){}},resize_uploaded_img:{enabled:!1,maxWidth:600,maxHeight:600},show_loading_text:{enabled:!0,text:E,icon:"fa-spinner",cclass:"form-control-static",style:"margin:0px!important;"},config:{codeview:{enabled:!1,showButton:!1},autosubmit:!0,basePath:S,images:{allowLocal:!0,upload:{handler:function(e,t,r){N(e.blob(),e.filename(),function(e){e.done(function(e,r,n){if(o.img_upload_response.success(e,r,n),!e.result)throw o.debug_mode&&I(n),new Error(a.replace("%s",""));o.debug_mode&&I(x.replace("%s",e.ruta)),t(e.ruta)}).fail(function(e,t,r){throw o.img_upload_response.fail(e,t,r),o.debug_mode&&I(e),new Error(a.replace("%s","("+r+")"))})})}}}}};return z.textboxio&&delete e.config.basePath,e},R=function(){switch(o.toolbar){case"tiny":o.config.ui={toolbar:{items:[{label:"Undo and Redo group",items:["undo","redo"]},{label:"Insert group",items:[{id:"insert",label:"Insertar",items:["link"]}]},{label:"Emphasis group",items:["bold","italic","underline"]},{label:"Format group",items:["font-menu","removeformat"]}]}};break;case"normal":o.config.ui={toolbar:{items:[{label:"Undo and Redo group",items:["undo","redo"]},{label:"Insert group",items:[{id:"insert",label:"Insertar",items:["link","fileupload","table","specialchar","hr"]}]},{label:"Styles group",items:["styles"]},{label:"Emphasis group",items:["bold","italic","underline"]},{label:"Align group",items:["alignment"]},{label:"Listindent group",items:["ul","ol","indent","outdent","blockquote"]},{label:"Format group",items:["font-menu","removeformat"]},{label:"Tools group",items:["find","fullscreen","usersettings"]}]}}}},H=function(e){$.each(e,function(e,t){if(!/TEXTAREA|DIV/i.test(t.nodeName))throw new Error(v);try{var r=textboxio.replace(t,o.config)}catch(n){z.textboxio&&!o.config.basePath&&(o.config.basePath=S);var r=textboxio.replace(t,o.config)}o.debug_mode&&(I(m.replace("%s",t.nodeName)),I(t)),r.events.loaded.addListener(function(){var e=r.content.documentElement(),n=e.body,i=r.element(),a=$(document).find(i).parent();if(/TEXTAREA/i.test(t.nodeName)&&$.data(r.element(),"element",t),o.debug_mode&&I(_),o.autoresize){var l=n.offsetHeight+81;l>o.init_height?a.height(l):a.height(o.init_height)}else a.height(o.init_height)}),r.events.focus.addListener(function(){/TEXTAREA/i.test(t.nodeName)&&$.data(r.element(),"element",t)}),r.events.dirty.addListener(function(){if(o.autoresize&&/TEXTAREA/i.test(t.nodeName)){var e=r.element(),n=$(document).find(e).parent();setInterval(function(){try{var e=r.content.documentElement(),t=e.querySelector("html"),i=e.querySelector("body"),a=i.offsetHeight+71;t.style.minHeight="inherit",t.style.height="inherit",i.style.minHeight=o.init_height-41+"px",a>o.init_height?n.height(a):n.height(o.init_height)}catch(l){}},500)}})})},N=function(e,t,r){var n,i,a,l=new FormData,s=new FileReader;s.onload=function(e){var s=new Image;s.onload=function(e){var d=document.createElement("canvas");P(s,d,o.resize_uploaded_img.maxWidth,o.resize_uploaded_img.maxHeight),a=d.toDataURL(),n=D(a),l.append("file",n),l.append("name",t),i=$.ajax({url:o.img_upload_url,type:"POST",dataType:"json",async:!0,cache:!1,data:l,contentType:!1,processData:!1}),r(i)},s.src=e.target.result},s.readAsDataURL(e)},P=function(e,t,r,n){var i=e.width,a=e.height,l=o.resize_uploaded_img.enabled&&i>r?!0:!1,s=1,d=1,c=1,d=r/i,c=n/a;s=c>d?d:c;var u=t.getContext("2d"),g=document.createElement("canvas"),h=g.getContext("2d"),m=document.createElement("canvas"),p=m.getContext("2d");g.width=i,g.height=a,h.drawImage(e,0,0),m.width=i,m.height=a,p.drawImage(g,0,0,g.width,g.height,0,0,m.width,m.height);for(var f=2,b=s*f,w=1;f>=w;w++)l?(g.width=i*b/w,g.height=a*b/w):(g.width=i,g.height=a),h.drawImage(m,0,0,m.width,m.height,0,0,g.width,g.height),l?(m.width=i*b/w,m.height=a*b/w):(m.width=i,m.height=a),p.drawImage(g,0,0,g.width,g.height,0,0,m.width,m.height);l?(t.width=i*b/f,t.height=a*b/f):(t.width=i,t.height=a),u.drawImage(m,0,0,m.width,m.height,0,0,t.width,t.height)},D=function(e){var t=";base64,";if(-1==e.indexOf(t)){var o=e.split(","),r=o[0].split(":")[1],n=o[1];return new Blob([n],{type:r})}for(var o=e.split(t),r=o[0].split(":")[1],n=window.atob(o[1]),i=n.length,a=new Uint8Array(i),l=0;i>l;++l)a[l]=n.charCodeAt(l);return new Blob([a],{type:r})},L=function(e){e.hide(),e.each(function(e,t){$(t).parent().append('<label class="loadingTextboxValora '+o.show_loading_text.cclass+'" style="'+o.show_loading_text.style+'"><i class="fa fa-spin '+o.show_loading_text.icon+'"></i> '+o.show_loading_text.text+"</label>")})},C=function(e){$(".loadingTextboxValora").remove(),e.show()},O=function(){A||(e=$.ajax({dataType:"script",cache:!1,async:!0,url:T,beforeSend:function(){A=!0}}).fail(function(e,t,r){throw o.debug_mode&&I(e),new Error(i.replace("%s","("+r+")"))}))},U=function(){if("boolean"!=typeof o.debug_mode)throw new Error(c.replace("%s","debug_mode"));if("string"!=typeof o.toolbar)throw new Error(s.replace("%s","toolbar"));if("boolean"!=typeof o.autoresize)throw new Error(c.replace("%s","autoresize"));if("number"!=typeof o.init_height)throw new Error(g.replace("%s","init_height"));if("string"!=typeof o.img_upload_url)throw new Error(s.replace("%s","img_upload_url"));if("function"!=typeof o.img_upload_response.success)throw new Error(u.replace("%s","img_upload_response.success"));if("function"!=typeof o.img_upload_response.fail)throw new Error(u.replace("%s","img_upload_response.fail"));if("boolean"!=typeof o.resize_uploaded_img.enabled)throw new Error(c.replace("%s","resize_uploaded_img.enabled"));if("number"!=typeof o.resize_uploaded_img.maxWidth)throw new Error(g.replace("%s","resize_uploaded_img.maxWidth"));if("number"!=typeof o.resize_uploaded_img.maxHeight)throw new Error(g.replace("%s","resize_uploaded_img.maxHeight"))},r={get:function(e){if(window.textboxio){if(0==arguments.length)throw new Error(l.replace("%s","selector"));if("string"!=typeof e)throw new Error(s.replace("%s","Selector"));return textboxio.get(e)}return!1},triggerSave:function(e){if(0==arguments.length)throw new Error(l.replace("%s","selector"));if("string"!=typeof e)throw new Error(s.replace("%s","Selector"));var t=r.get(e);t.length>0&&$.each(t,function(e,t){if(t.content.isDirty()){var r=$.data(t.element(),"element");if("object"==typeof r){var n=t.content.get();/TEXTAREA/i.test(r.nodeName)?(r.innerHTML=n.replace(/^(<p[^>]*>(&nbsp;|&#160;|\s|\u00a0|)*<br \/>*[\r\n]*<\/p>*)$/,""),o.debug_mode&&(I(p.replace("%s",r.nodeName)),I(r))):o.debug_mode&&(I(y),I(r))}else o.debug_mode&&(I(y),I(r));t.content.setDirty(!1)}})},replace:function(r,n){if(0==arguments.length)throw new Error(l.replace("%s","selector"));if("undefined"==typeof r||"number"==typeof r)throw new Error(s.replace("%s","Selector")+" o "+d.replace("%s","Selector"));if("undefined"!=typeof n&&"object"!=typeof n)throw new Error(d.replace("%s","Argument 2"));if(r=$(r),t=j(),o=$.extend(!0,{},t,n),R(),U(),r.length>0)if(z.textboxio)H(r);else{o.debug_mode&&I(f),O(),o.show_loading_text.enabled&&L(r);var i=z.setInterval(function(){4==e.readyState&&200==e.status&&(o.debug_mode&&(I(b),I(w.replace("%s",o.toolbar))),clearInterval(i),o.show_loading_text.enabled&&C(r),H(r))},1e3)}else o.debug_mode&&I(h)}};Object.preventExtensions(r),Object.defineProperty(r,"get",{writable:!1,configurable:!1,enumerable:!0}),Object.defineProperty(r,"triggerSave",{writable:!1,configurable:!1,enumerable:!0}),Object.defineProperty(r,"replace",{writable:!1,configurable:!1,enumerable:!0}),z.textboxValora=r}(this);