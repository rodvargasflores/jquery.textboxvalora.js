/*
TextBox v0.4.0
Plugin que sirve para precargar la librería textboxio de ephox de acuerdo a estándar de ecosistema VALORA
Autor: Real Ace One
*/
if("undefined"===!window.jQuery)throw new Error("Cargue primero la librería JQuery");!function(){"use strict";var e,t,r,o,n="Textboxio",i="No se puede cargar la librería "+n+" %s",a="Ha ocurrido un problema con la subida del archivo. Por favor intente nuevamente. %s",l='Falta el parámetro "%s"',s='"%s" debe ser un string.',d='"%s" debe ser un objeto.',u='"%s" debe ser boolean.',c='"%s" debe ser una función.',g='"%s" debe ser númerico.',h="No se encontró ningún elemento para reemplazar.",m='Se crea instancia de editor en "%s"',p='Se guarda contenido en elemento "%s"',f="No se encuentra la librería "+n+". Se intentará cargar dinámicamente.",b="Se cargó exitosamente la librería "+n+".",w='Se cargó la barra de herramientas en modo "%s"',_="Se carga GUI del editor.",y='Se cargó el archivo en el servidor con ruta de acceso "%s"',v="El elemento en que se intenta guardar el contenido del editor no está permitido.",E="Sólo se permiten elementos de tipo DIV o TEXTAREA.",x="/assets/vendor/plugins/textboxio/textboxio.js",S="/assets/vendor/plugins/textboxio/",T=!1,A=window,z=function(e){console.log(e)},I=function(){var e={debug_mode:!1,toolbar:"normal",autoresize:!1,init_height:200,img_upload_url:"/default/subir-complemento/",img_upload_response:{success:function(e,t,r){},fail:function(e,t,r){}},resize_uploaded_img:{enabled:!1,maxWidth:600,maxHeight:600},config:{codeview:{enabled:!1,showButton:!1},autosubmit:!0,basePath:S,images:{allowLocal:!0,upload:{handler:function(e,t,o){H(e.blob(),e.filename(),function(e){e.done(function(e,o,n){if(r.img_upload_response.success(e,o,n),!e.result)throw r.debug_mode&&z(n),new Error(a.replace("%s",""));r.debug_mode&&z(y.replace("%s",e.ruta)),t(e.ruta)}).fail(function(e,t,o){throw r.img_upload_response.fail(e,t,o),r.debug_mode&&z(e),new Error(a.replace("%s","("+o+")"))})})}}}}};return A.textboxio&&delete e.config.basePath,e},j=function(){switch(r.toolbar){case"tiny":r.config.ui={toolbar:{items:[{label:"Undo and Redo group",items:["undo","redo"]},{label:"Emphasis group",items:["bold","italic","underline"]},{label:"Format group",items:["font-menu","removeformat"]}]}};break;case"normal":r.config.ui={toolbar:{items:[{label:"Undo and Redo group",items:["undo","redo"]},{label:"Insert group",items:[{id:"insert",label:"Insertar",items:["fileupload","table","specialchar","hr"]}]},{label:"Styles group",items:["styles"]},{label:"Emphasis group",items:["bold","italic","underline"]},{label:"Align group",items:["alignment"]},{label:"Listindent group",items:["ul","ol","indent","outdent","blockquote"]},{label:"Format group",items:["font-menu","removeformat"]},{label:"Tools group",items:["find","fullscreen","usersettings"]}]}}}},R=function(e){$.each(e,function(e,t){if(!/TEXTAREA|DIV/i.test(t.nodeName))throw new Error(E);try{var o=textboxio.replace(t,r.config)}catch(n){A.textboxio&&!r.config.basePath&&(r.config.basePath=S);var o=textboxio.replace(t,r.config)}r.debug_mode&&(z(m.replace("%s",t.nodeName)),z(t)),o.events.loaded.addListener(function(){var e=o.content.documentElement(),n=e.body,i=o.element(),a=$(document).find(i).parent();if(/TEXTAREA/i.test(t.nodeName)&&$.data(o.element(),"element",t),r.debug_mode&&z(_),r.autoresize){var l=n.offsetHeight+81;l>r.init_height?a.height(l):a.height(r.init_height)}else a.height(r.init_height)}),o.events.focus.addListener(function(){/TEXTAREA/i.test(t.nodeName)&&$.data(o.element(),"element",t)}),o.events.dirty.addListener(function(){if(r.autoresize&&/TEXTAREA/i.test(t.nodeName)){var e=o.element(),n=$(document).find(e).parent();setInterval(function(){try{var e=o.content.documentElement(),t=e.querySelector("html"),i=e.querySelector("body"),a=i.offsetHeight+71;t.style.minHeight="inherit",t.style.height="inherit",i.style.minHeight=r.init_height-41+"px",a>r.init_height?n.height(a):n.height(r.init_height)}catch(l){}},500)}})})},H=function(e,t,o){var n,i,a,l=new FormData,s=new FileReader;s.onload=function(e){var s=new Image;s.onload=function(e){var d=document.createElement("canvas");N(s,d,r.resize_uploaded_img.maxWidth,r.resize_uploaded_img.maxHeight),a=d.toDataURL(),n=P(a),l.append("file",n),l.append("name",t),i=$.ajax({url:r.img_upload_url,type:"POST",dataType:"json",async:!0,cache:!1,data:l,contentType:!1,processData:!1}),o(i)},s.src=e.target.result},s.readAsDataURL(e)},N=function(e,t,o,n){var i=e.width,a=e.height,l=r.resize_uploaded_img.enabled&&i>o?!0:!1,s=1,d=1,u=1,d=o/i,u=n/a;s=u>d?d:u;var c=t.getContext("2d"),g=document.createElement("canvas"),h=g.getContext("2d"),m=document.createElement("canvas"),p=m.getContext("2d");g.width=i,g.height=a,h.drawImage(e,0,0),m.width=i,m.height=a,p.drawImage(g,0,0,g.width,g.height,0,0,m.width,m.height);for(var f=2,b=s*f,w=1;f>=w;w++)l?(g.width=i*b/w,g.height=a*b/w):(g.width=i,g.height=a),h.drawImage(m,0,0,m.width,m.height,0,0,g.width,g.height),l?(m.width=i*b/w,m.height=a*b/w):(m.width=i,m.height=a),p.drawImage(g,0,0,g.width,g.height,0,0,m.width,m.height);l?(t.width=i*b/f,t.height=a*b/f):(t.width=i,t.height=a),c.drawImage(m,0,0,m.width,m.height,0,0,t.width,t.height)},P=function(e){var t=";base64,";if(-1==e.indexOf(t)){var r=e.split(","),o=r[0].split(":")[1],n=r[1];return new Blob([n],{type:o})}for(var r=e.split(t),o=r[0].split(":")[1],n=window.atob(r[1]),i=n.length,a=new Uint8Array(i),l=0;i>l;++l)a[l]=n.charCodeAt(l);return new Blob([a],{type:o})},D=function(){T||(e=$.ajax({dataType:"script",cache:!1,async:!0,url:x,beforeSend:function(){T=!0}}).fail(function(e,t,o){throw r.debug_mode&&z(e),new Error(i.replace("%s","("+o+")"))}))},L=function(){if("boolean"!=typeof r.debug_mode)throw new Error(u.replace("%s","debug_mode"));if("string"!=typeof r.toolbar)throw new Error(s.replace("%s","toolbar"));if("boolean"!=typeof r.autoresize)throw new Error(u.replace("%s","autoresize"));if("number"!=typeof r.init_height)throw new Error(g.replace("%s","init_height"));if("string"!=typeof r.img_upload_url)throw new Error(s.replace("%s","img_upload_url"));if("function"!=typeof r.img_upload_response.success)throw new Error(c.replace("%s","img_upload_response.success"));if("function"!=typeof r.img_upload_response.fail)throw new Error(c.replace("%s","img_upload_response.fail"));if("boolean"!=typeof r.resize_uploaded_img.enabled)throw new Error(u.replace("%s","resize_uploaded_img.enabled"));if("number"!=typeof r.resize_uploaded_img.maxWidth)throw new Error(g.replace("%s","resize_uploaded_img.maxWidth"));if("number"!=typeof r.resize_uploaded_img.maxHeight)throw new Error(g.replace("%s","resize_uploaded_img.maxHeight"))},o={get:function(e){if(window.textboxio){if(0==arguments.length)throw new Error(l.replace("%s","selector"));if("string"!=typeof e)throw new Error(s.replace("%s","Selector"));return textboxio.get(e)}return!1},triggerSave:function(e){if(0==arguments.length)throw new Error(l.replace("%s","selector"));if("string"!=typeof e)throw new Error(s.replace("%s","Selector"));var t=o.get(e);t.length>0&&$.each(t,function(e,t){if(t.content.isDirty()){var o=$.data(t.element(),"element");if("object"==typeof o){var n=t.content.get();/TEXTAREA/i.test(o.nodeName)?(o.innerHTML=n.replace(/^(<p[^>]*>(&nbsp;|&#160;|\s|\u00a0|)*<br \/>*[\r\n]*<\/p>*)$/,""),r.debug_mode&&(z(p.replace("%s",o.nodeName)),z(o))):r.debug_mode&&(z(v),z(o))}else r.debug_mode&&(z(v),z(o));t.content.setDirty(!1)}})},replace:function(o,n){if(0==arguments.length)throw new Error(l.replace("%s","selector"));if("undefined"==typeof o||"number"==typeof o)throw new Error(s.replace("%s","Selector")+" o "+d.replace("%s","Selector"));if("undefined"!=typeof n&&"object"!=typeof n)throw new Error(d.replace("%s","Argument 2"));if(o=$(o),t=I(),r=$.extend(!0,{},t,n),j(),L(),o.length>0)if(A.textboxio)R(o);else{r.debug_mode&&z(f),D();var i=A.setInterval(function(){4==e.readyState&&200==e.status&&(r.debug_mode&&(z(b),z(w.replace("%s",r.toolbar))),clearInterval(i),R(o))},1e3)}else r.debug_mode&&z(h)}};Object.preventExtensions(o),Object.defineProperty(o,"get",{writable:!1,configurable:!1,enumerable:!0}),Object.defineProperty(o,"triggerSave",{writable:!1,configurable:!1,enumerable:!0}),Object.defineProperty(o,"replace",{writable:!1,configurable:!1,enumerable:!0}),A.textboxValora=o}(this);